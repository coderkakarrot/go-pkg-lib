name: Go Packages Lint and Test
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # JOB to run change detection
  changes:
    runs-on: ubuntu-latest
    # Required permissions
    permissions:
      pull-requests: read
    # Set job outputs to values from filter step
    outputs:
      metric: ${{ steps.filter.outputs.metric }}
      api_rest: ${{ steps.filter.outputs.api_rest }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            metric:
              - 'metric/**'
            api_rest:
              - 'api/rest/**'

  mertric-package-lint-test:
    needs: changes
    if: ${{ needs.changes.outputs.metric == 'true' }}
    uses: ./.github/workflows/reusable-go-package-lint-test.yml
    with:
      target_directory: 'metric'
      golangci_lint_config_file: '../.golangci.yml'
      go_version: '1.22.3'
      golangci_version: 'v1.58.1'

  api-rest-package-lint-test:
    needs: changes
    if: ${{ needs.changes.outputs.api_rest == 'true' }}
    uses: ./.github/workflows/reusable-go-package-lint-test.yml
    with:
      target_directory: 'api/rest'
      golangci_lint_config_file: '../../.golangci.yml'
      go_version: '1.22.3'
      golangci_version: 'v1.58.1'
